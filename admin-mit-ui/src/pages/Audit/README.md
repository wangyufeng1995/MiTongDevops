# 运维审计模块

## 概述

运维审计模块提供了完整的系统操作审计和主机操作审计功能，帮助管理员追踪和监控系统中的所有操作行为。

## 功能模块

### 1. 操作日志 (OperationLogs)

系统操作日志记录了用户在系统中的所有操作行为，包括：

#### 主要功能
- **日志列表展示**：表格形式展示所有操作日志
- **多维度筛选**：
  - 关键词搜索（操作、资源）
  - 用户名筛选
  - 操作类型筛选（创建、更新、删除、查看、登录、登出）
  - 时间范围筛选（开始日期、结束日期）
- **统计信息**：
  - 总记录数统计
  - 今日记录数统计
- **日志详情查看**：点击查看完整的操作详情
- **日志管理**（管理员）：
  - 单条日志删除
  - 批量删除选中日志
  - 按时间范围清空日志
- **数据导出**：支持导出日志为 CSV 格式

#### 日志信息
每条日志包含以下信息：
- 操作时间
- 操作用户（用户名、全名）
- 操作类型
- 操作资源及资源ID
- 操作IP地址
- 详细操作内容

### 2. 主机审计 (HostAudit)

主机审计日志记录了通过 WebShell 在主机上执行的所有命令，包括：

#### 主要功能
- **主机选择**：下拉选择要查看审计日志的主机
- **统计卡片**：
  - 总命令数
  - 成功执行数
  - 已阻止数
  - 执行失败数
- **日志列表展示**：
  - 执行时间
  - 执行用户
  - 执行命令
  - 执行状态（成功/已阻止/失败）
  - 来源IP地址
- **详情展开**：
  - 完整命令内容
  - 阻止原因（如果被阻止）
  - 输出摘要
  - 错误信息
  - 会话ID、执行时间、耗时等
- **筛选功能**：
  - 按状态筛选
  - 按时间范围筛选
- **日志清理**（管理员）：
  - 按保留天数清理历史日志
  - 支持清空所有日志

#### 审计状态
- **成功 (success)**：命令成功执行
- **已阻止 (blocked)**：命令被安全策略阻止
- **失败 (failed)**：命令执行失败

## 路由配置

```typescript
/audit                    # 运维审计主页（重定向到操作日志）
/audit/operations         # 操作日志页面
/audit/hosts              # 主机审计页面
```

## 权限要求

### 操作日志
- **查看权限**：`log:read`
- **导出权限**：`log:export`
- **删除权限**：管理员权限

### 主机审计
- **查看权限**：`host:audit` 或 `host:read`
- **配置权限**：`host:audit:config`（清理日志）

## 技术实现

### 组件结构
```
Audit/
├── index.tsx              # 路由配置
├── OperationLogs.tsx      # 操作日志页面
├── HostAudit.tsx          # 主机审计页面
└── README.md              # 文档说明
```

### 使用的组件
- `MonitorPageLayout`：页面布局组件
- `MonitorContentCard`：内容卡片组件
- `MonitorStatCard`：统计卡片组件
- `SearchForm`：搜索表单组件
- `LogDetailModal`：日志详情弹窗
- `DataTable`：数据表格组件
- `Modal`：通用弹窗组件

### 服务接口
- `logService`：操作日志服务
  - `getLogs()`：获取日志列表
  - `deleteLog()`：删除单条日志
  - `batchDeleteLogs()`：批量删除日志
  - `clearLogs()`：清空日志
  - `exportLogs()`：导出日志
- `hostAuditService`：主机审计服务
  - `getAuditLogs()`：获取审计日志
  - `getAuditStats()`：获取统计数据
  - `clearAuditLogs()`：清理审计日志

## 使用示例

### 查看操作日志
1. 进入"运维审计" > "操作日志"
2. 使用筛选条件查找特定日志
3. 点击"详情"按钮查看完整信息
4. 可导出日志进行离线分析

### 查看主机审计
1. 进入"运维审计" > "主机审计"
2. 选择要查看的主机
3. 查看统计信息和命令执行记录
4. 点击展开按钮查看命令详情
5. 使用筛选功能查找特定记录

### 清理历史日志
1. 管理员进入相应页面
2. 点击"清空日志"或"清理日志"按钮
3. 选择保留天数
4. 确认清理操作

## 注意事项

1. **权限控制**：
   - 普通用户只能查看日志
   - 管理员可以删除和清理日志
   - 导出功能需要特定权限

2. **数据安全**：
   - 删除和清理操作不可恢复
   - 建议定期导出重要日志
   - 清理前请确认保留天数

3. **性能优化**：
   - 日志列表支持分页加载
   - 使用筛选条件减少数据量
   - 定期清理历史日志保持性能

4. **审计合规**：
   - 所有操作都有完整记录
   - 支持按时间范围查询
   - 可导出用于合规审计

## 更新日志

### v1.0.0 (2026-01-17)
- 从"操作日志"重构为"运维审计"模块
- 新增主机审计子菜单
- 整合操作日志和主机审计功能
- 优化UI样式和用户体验
- 完善权限控制和安全策略
