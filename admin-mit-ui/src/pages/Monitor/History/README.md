# 告警历史模块

## 功能概述

告警历史模块提供了完整的告警记录查询和统计分析功能，帮助用户了解系统告警情况和趋势。

## 主要功能

### 1. 告警历史列表 (AlertHistory.tsx)

#### 核心功能
- **告警记录展示**：以表格形式展示所有历史告警记录
- **多维度筛选**：
  - 关键词搜索（告警信息、规则名称）
  - 状态筛选（活跃、已确认、已解决、已忽略）
  - 级别筛选（严重、警告、信息）
  - 指标筛选（CPU、内存、磁盘、负载）
  - 时间范围筛选（开始时间、结束时间）
- **统计卡片**：显示总告警数、活跃告警、已确认、已解决、严重告警数量
- **快速操作**：
  - 确认告警
  - 忽略告警
  - 查看详情
- **分页支持**：支持自定义每页显示数量和快速跳转
- **导出功能**：支持导出告警数据

#### 数据字段

```typescript
interface AlertRecord {
  id: number                      // 告警ID
  rule_id: number                 // 规则ID
  host_id: number                 // 主机ID
  metric_type: string             // 指标类型
  metric_value: number            // 当前值
  threshold_value: number         // 阈值
  condition_operator: string      // 条件操作符
  severity: string                // 严重级别
  status: string                  // 状态
  message: string                 // 告警信息
  first_triggered_at: string      // 首次触发时间
  last_triggered_at: string       // 最后触发时间
  trigger_count: number           // 触发次数
  acknowledged_by?: string        // 确认人
  acknowledged_at?: string        // 确认时间
  resolved_at?: string            // 解决时间
  rule_info?: object              // 规则信息
  host_info?: object              // 主机信息
  notification_stats?: object     // 通知统计
}
```

### 2. 告警统计分析 (AlertStatistics.tsx)

#### 核心功能
- **统计卡片**：显示总告警数、活跃告警、解决率、平均处理时间
- **告警趋势图**：展示告警数量随时间的变化趋势
- **级别分布图**：饼图展示不同级别告警的分布
- **每日统计图**：柱状图展示每日新增和解决的告警数量
- **详细统计**：
  - 级别统计（严重、警告、信息）
  - 来源统计（不同监控来源）
- **时间范围选择**：支持查看最近7天、30天、90天的数据

#### 统计数据

```typescript
interface StatisticsData {
  total_alerts: number            // 总告警数
  active_alerts: number           // 活跃告警数
  acknowledged_alerts: number     // 已确认数
  resolved_alerts: number         // 已解决数
  critical_alerts: number         // 严重告警数
  warning_alerts: number          // 警告告警数
  info_alerts: number             // 信息告警数
  avg_resolution_time: number     // 平均处理时间
  resolution_rate: number         // 解决率
  trend_data: Array               // 趋势数据
  level_distribution: Array       // 级别分布
  source_distribution: Array      // 来源分布
  daily_stats: Array              // 每日统计
}
```

## 技术特性

### UI/UX
- **响应式设计**：适配桌面和移动设备
- **深色模式支持**：自动适配系统主题
- **实时反馈**：Toast提示、加载状态、错误提示
- **交互式图表**：使用ECharts展示统计数据
- **确认对话框**：危险操作需要二次确认

### 数据交互
- **RESTful API**：与后端API完全对接
- **分页加载**：支持大量数据的高效展示
- **防抖搜索**：优化搜索性能
- **时间范围筛选**：支持自定义时间范围

### 组件复用
- 使用 `MonitorPageLayout` 统一页面布局
- 使用 `MonitorContentCard` 统一内容卡片样式
- 使用 `MonitorStatCard` 统一统计卡片样式
- 使用 `DataTable` 统一表格展示
- 使用 `ConfirmDialog` 统一确认对话框
- 使用 `ReactECharts` 展示图表

## API接口

### 获取告警记录列表
```
GET /api/monitor/alerts
参数：
  - page: 页码
  - per_page: 每页数量
  - search: 搜索关键词
  - status: 状态筛选
  - severity: 级别筛选
  - metric_type: 指标筛选
  - rule_id: 规则ID
  - host_id: 主机ID
  - start_date: 开始时间
  - end_date: 结束时间
```

### 确认告警
```
POST /api/monitor/alerts/:id/ack
```

### 忽略告警
```
POST /api/monitor/alerts/:id/ignore
```

### 获取告警统计
```
GET /api/monitor/alerts/statistics
参数：
  - time_range: 时间范围（7d/30d/90d）
```

## 使用示例

### 查看告警历史

1. 访问 `/monitor/history/alerts`
2. 查看告警记录列表
3. 使用筛选功能查找特定告警
4. 点击操作按钮处理告警

### 查看告警统计

1. 访问 `/monitor/history/statistics`
2. 选择时间范围
3. 查看统计图表和数据
4. 分析告警趋势

### 处理告警

**确认告警**
1. 在告警列表中找到需要确认的告警
2. 点击"确认"按钮
3. 告警状态变为"已确认"

**忽略告警**
1. 在告警列表中找到需要忽略的告警
2. 点击"忽略"按钮
3. 在确认对话框中确认操作
4. 告警状态变为"已忽略"

## 注意事项

1. **时间范围**：时间范围筛选使用ISO格式
2. **权限要求**：查看告警历史不需要特殊权限
3. **数据量**：大量数据时建议使用筛选和分页功能
4. **导出功能**：导出功能正在开发中
5. **统计数据**：统计数据基于筛选条件计算

## 后续优化建议

1. **导出功能**：完善导出功能，支持CSV、Excel格式
2. **告警详情**：添加告警详情页面，显示完整信息
3. **批量操作**：支持批量确认、忽略告警
4. **自定义图表**：支持用户自定义统计图表
5. **告警关联**：显示告警之间的关联关系
6. **告警分析**：提供智能告警分析和建议
7. **实时更新**：支持告警列表实时更新
8. **告警通知**：显示告警通知发送状态

## 常见问题

### Q1：为什么看不到某些告警？

**可能原因**：
1. 告警被筛选条件过滤
2. 告警不在当前时间范围内
3. 告警已被删除
4. 租户隔离限制

**解决方案**：
1. 清除筛选条件
2. 调整时间范围
3. 检查告警状态
4. 确认租户权限

### Q2：统计数据不准确？

**可能原因**：
1. 数据正在加载
2. 时间范围设置不正确
3. 筛选条件影响统计
4. 缓存问题

**解决方案**：
1. 等待数据加载完成
2. 检查时间范围设置
3. 清除筛选条件
4. 刷新页面

### Q3：如何导出告警数据？

**当前状态**：导出功能正在开发中

**临时方案**：
1. 使用浏览器的打印功能
2. 截图保存
3. 手动复制数据

### Q4：告警处理后还显示在列表中？

**说明**：
- 已确认的告警仍会显示在列表中，状态为"已确认"
- 已忽略的告警仍会显示在列表中，状态为"已忽略"
- 可以通过状态筛选查看不同状态的告警

### Q5：如何查看告警详情？

**操作步骤**：
1. 在告警列表中找到目标告警
2. 点击"查看详情"按钮
3. 跳转到告警详情页面（开发中）

## 性能优化

### 前端优化
- 搜索防抖（300ms）
- 分页加载
- 图表懒加载
- 数据缓存

### 后端优化
- 数据库索引
- 查询优化
- 分页查询
- 缓存机制

## 安全性

### 数据隔离
- 租户隔离
- 权限控制
- 数据验证

### 操作审计
- 记录操作日志
- 追踪操作人
- 记录操作时间

## 总结

告警历史模块提供了完整的告警记录查询和统计分析功能，帮助用户：

1. **快速查找**：通过多维度筛选快速找到目标告警
2. **及时处理**：快速确认或忽略告警
3. **趋势分析**：通过统计图表了解告警趋势
4. **优化规则**：根据历史数据优化告警规则
5. **提高效率**：减少告警处理时间

建议：
- 定期查看告警历史
- 分析告警趋势
- 优化告警规则
- 及时处理活跃告警
- 关注严重告警
