# 告警规则使用示例

## 快速开始

### 步骤1：创建告警渠道

在创建告警规则之前，需要先配置告警渠道。

1. 访问 `/monitor/channels`
2. 点击"创建渠道"
3. 配置邮件或钉钉渠道
4. 测试渠道连接
5. 启用渠道

### 步骤2：创建告警规则

1. 访问 `/monitor/rules`
2. 点击"创建规则"
3. 填写规则信息
4. 保存规则

## 实战示例

### 示例1：基础CPU告警

**场景**：监控所有服务器的CPU使用率，当超过80%持续5分钟时发送告警。

**配置步骤**：

1. **基本信息**
   - 规则名称：`服务器CPU使用率告警`
   - 描述：`监控所有服务器CPU使用率，超过80%时告警`

2. **监控条件**
   - 监控指标：`CPU使用率`
   - 条件操作符：`>`
   - 阈值：`80`
   - 持续时间：`300`（5分钟）
   - 严重级别：`警告`
   - 静默期：`3600`（1小时）

3. **应用范围**
   - ✓ 应用到所有主机

4. **告警渠道**
   - ✓ 邮件通知
   - ✓ 钉钉通知

5. **规则状态**
   - ✓ 启用此规则

**预期效果**：
- 当任何服务器的CPU使用率超过80%并持续5分钟时，系统会通过邮件和钉钉发送告警
- 同一服务器的相同告警在1小时内不会重复发送

---

### 示例2：数据库服务器内存告警

**场景**：专门监控数据库服务器的内存使用率，当超过90%时立即告警。

**配置步骤**：

1. **基本信息**
   - 规则名称：`数据库服务器内存告警`
   - 描述：`数据库服务器内存使用率超过90%时立即告警`

2. **监控条件**
   - 监控指标：`内存使用率`
   - 条件操作符：`>`
   - 阈值：`90`
   - 持续时间：`60`（1分钟）
   - 严重级别：`严重`
   - 静默期：`1800`（30分钟）

3. **应用范围**
   - ☐ 应用到所有主机
   - ✓ db-server-01
   - ✓ db-server-02

4. **告警渠道**
   - ✓ 邮件通知
   - ✓ 钉钉通知

5. **规则状态**
   - ✓ 启用此规则

**预期效果**：
- 只监控选定的数据库服务器
- 内存使用率超过90%持续1分钟即告警
- 严重级别的告警会更醒目
- 30分钟内不会重复告警

---

### 示例3：日志服务器磁盘空间告警

**场景**：监控日志服务器的磁盘使用率，当超过85%时提前告警。

**配置步骤**：

1. **基本信息**
   - 规则名称：`日志服务器磁盘空间告警`
   - 描述：`日志服务器磁盘使用率超过85%时告警，提前清理日志`

2. **监控条件**
   - 监控指标：`磁盘使用率`
   - 条件操作符：`>`
   - 阈值：`85`
   - 持续时间：`600`（10分钟）
   - 严重级别：`警告`
   - 静默期：`7200`（2小时）

3. **应用范围**
   - ☐ 应用到所有主机
   - ✓ log-server-01

4. **告警渠道**
   - ✓ 邮件通知

5. **规则状态**
   - ✓ 启用此规则

**预期效果**：
- 只监控日志服务器
- 磁盘使用率超过85%持续10分钟后告警
- 通过邮件通知运维人员清理日志
- 2小时内不会重复告警

---

### 示例4：Web服务器负载告警

**场景**：监控Web服务器的系统负载，当负载过高时告警。

**配置步骤**：

1. **基本信息**
   - 规则名称：`Web服务器负载告警`
   - 描述：`Web服务器系统负载超过4.0时告警`

2. **监控条件**
   - 监控指标：`系统负载`
   - 条件操作符：`>`
   - 阈值：`4.0`
   - 持续时间：`300`（5分钟）
   - 严重级别：`警告`
   - 静默期：`3600`（1小时）

3. **应用范围**
   - ☐ 应用到所有主机
   - ✓ web-server-01
   - ✓ web-server-02
   - ✓ web-server-03

4. **告警渠道**
   - ✓ 邮件通知
   - ✓ 钉钉通知

5. **规则状态**
   - ✓ 启用此规则

**预期效果**：
- 监控所有Web服务器
- 系统负载超过4.0持续5分钟后告警
- 通过邮件和钉钉通知
- 1小时内不会重复告警

---

### 示例5：测试环境低优先级告警

**场景**：监控测试环境服务器，使用较宽松的阈值和较低的优先级。

**配置步骤**：

1. **基本信息**
   - 规则名称：`测试环境CPU告警`
   - 描述：`测试环境服务器CPU使用率监控`

2. **监控条件**
   - 监控指标：`CPU使用率`
   - 条件操作符：`>`
   - 阈值：`90`
   - 持续时间：`600`（10分钟）
   - 严重级别：`信息`
   - 静默期：`7200`（2小时）

3. **应用范围**
   - ☐ 应用到所有主机
   - ✓ test-server-01
   - ✓ test-server-02

4. **告警渠道**
   - ✓ 邮件通知

5. **规则状态**
   - ✓ 启用此规则

**预期效果**：
- 只监控测试环境服务器
- 使用较高的阈值（90%）
- 较长的持续时间（10分钟）
- 信息级别，不会打扰
- 只通过邮件通知

---

## 高级场景

### 场景6：多级告警

为同一指标设置多个告警级别。

**第一级：警告**
```
规则名称：CPU使用率警告
监控指标：CPU使用率
条件：> 70%
持续时间：300秒
严重级别：警告
告警渠道：邮件
```

**第二级：严重**
```
规则名称：CPU使用率严重告警
监控指标：CPU使用率
条件：> 90%
持续时间：180秒
严重级别：严重
告警渠道：邮件 + 钉钉
```

**效果**：
- CPU使用率超过70%时发送警告邮件
- CPU使用率超过90%时发送严重告警（邮件+钉钉）
- 运维人员可以根据告警级别采取不同的处理措施

---

### 场景7：业务高峰期特殊规则

在业务高峰期使用不同的阈值。

**平时规则**
```
规则名称：常规CPU告警
监控指标：CPU使用率
条件：> 70%
启用状态：启用
```

**高峰期规则**
```
规则名称：高峰期CPU告警
监控指标：CPU使用率
条件：> 85%
启用状态：禁用（高峰期前手动启用）
```

**操作流程**：
1. 高峰期前：禁用"常规CPU告警"，启用"高峰期CPU告警"
2. 高峰期后：启用"常规CPU告警"，禁用"高峰期CPU告警"

---

### 场景8：组合条件告警

通过创建多个规则实现组合条件。

**规则1：CPU高**
```
规则名称：CPU使用率高
监控指标：CPU使用率
条件：> 80%
```

**规则2：内存高**
```
规则名称：内存使用率高
监控指标：内存使用率
条件：> 80%
```

**效果**：
- 当CPU或内存任一指标超过阈值时都会告警
- 如果两个指标同时超过阈值，会收到两条告警
- 可以通过告警记录分析系统瓶颈

---

## 规则管理最佳实践

### 1. 规则命名规范

**推荐格式**：`[环境]-[对象]-[指标]-[级别]`

示例：
- `生产-Web服务器-CPU-警告`
- `测试-数据库-内存-严重`
- `开发-所有主机-磁盘-信息`

### 2. 阈值设置建议

| 指标 | 警告阈值 | 严重阈值 | 说明 |
|------|---------|---------|------|
| CPU使用率 | 70-80% | 90%+ | 根据业务特点调整 |
| 内存使用率 | 80-85% | 90%+ | 预留缓冲空间 |
| 磁盘使用率 | 80-85% | 90%+ | 提前清理空间 |
| 系统负载 | CPU核心数×0.7 | CPU核心数×1.0 | 根据核心数调整 |

### 3. 持续时间设置

| 场景 | 建议时间 | 原因 |
|------|---------|------|
| 瞬时波动 | 60-180秒 | 避免误报 |
| 持续问题 | 300-600秒 | 确认问题存在 |
| 长期趋势 | 600-1800秒 | 观察趋势变化 |

### 4. 静默期设置

| 告警级别 | 建议静默期 | 原因 |
|---------|-----------|------|
| 信息 | 7200秒（2小时） | 降低通知频率 |
| 警告 | 3600秒（1小时） | 平衡及时性和频率 |
| 严重 | 1800秒（30分钟） | 确保及时处理 |

### 5. 渠道选择建议

| 告警级别 | 推荐渠道 | 原因 |
|---------|---------|------|
| 信息 | 邮件 | 不打扰，可批量查看 |
| 警告 | 邮件 + 钉钉 | 及时通知，不过度打扰 |
| 严重 | 邮件 + 钉钉 + 短信 | 确保收到通知 |

---

## 常见问题

### Q1：为什么我的规则没有触发告警？

**可能原因**：
1. 规则未启用
2. 条件未满足持续时间要求
3. 在静默期内
4. 告警渠道配置错误
5. 主机未在规则应用范围内

**排查步骤**：
1. 检查规则状态是否为"已启用"
2. 查看主机当前指标值
3. 检查告警历史记录
4. 测试告警渠道连接
5. 查看后端日志

### Q2：如何避免告警轰炸？

**解决方案**：
1. 设置合理的静默期
2. 使用适当的持续时间
3. 避免设置过低的阈值
4. 使用告警分组
5. 设置告警升级策略

### Q3：如何测试规则是否正确？

**测试方法**：
1. 创建测试规则，使用较低的阈值
2. 在测试环境验证
3. 使用规则测试功能（如果支持）
4. 查看告警历史记录
5. 验证告警渠道是否收到通知

### Q4：规则太多如何管理？

**管理建议**：
1. 使用清晰的命名规范
2. 添加详细的描述
3. 使用筛选功能
4. 定期审查和清理无用规则
5. 使用规则分组（如果支持）

### Q5：如何优化告警规则？

**优化建议**：
1. 分析历史告警数据
2. 调整阈值和持续时间
3. 优化静默期设置
4. 合并相似规则
5. 删除无效规则

---

## 监控策略建议

### 基础监控（必须）

1. **CPU使用率**
   - 警告：> 70%，持续5分钟
   - 严重：> 90%，持续3分钟

2. **内存使用率**
   - 警告：> 80%，持续5分钟
   - 严重：> 90%，持续3分钟

3. **磁盘使用率**
   - 警告：> 80%，持续10分钟
   - 严重：> 90%，持续5分钟

4. **系统负载**
   - 警告：> CPU核心数×0.7，持续5分钟
   - 严重：> CPU核心数×1.0，持续3分钟

### 进阶监控（推荐）

1. **网络流量**
2. **磁盘IO**
3. **进程状态**
4. **服务可用性**
5. **数据库连接数**
6. **应用响应时间**

### 业务监控（高级）

1. **订单量**
2. **支付成功率**
3. **API错误率**
4. **用户活跃度**
5. **业务指标异常**

---

## 总结

告警规则是监控系统的核心，合理配置告警规则可以：

1. **及时发现问题**：在问题影响业务前发现并处理
2. **减少误报**：通过合理的阈值和持续时间设置
3. **提高效率**：自动化监控，减少人工巡检
4. **优化资源**：根据告警数据优化系统配置
5. **保障稳定**：确保系统稳定运行

建议：
- 从基础监控开始，逐步完善
- 定期审查和优化规则
- 根据业务特点调整阈值
- 建立告警处理流程
- 持续改进监控策略
