# 告警规则功能测试指南

## 测试环境准备

### 1. 确保后端服务运行
```bash
cd admin-mit-backend
python app.py
```

### 2. 确保前端服务运行
```bash
cd admin-mit-ui
npm run dev
```

### 3. 登录系统
- 访问 http://localhost:5173
- 使用管理员账号登录

## 功能测试清单

### 一、规则列表页面测试

#### 1.1 页面访问
- [ ] 访问 `/monitor/rules` 自动跳转到 `/monitor/rules/list`
- [ ] 页面正常加载，显示规则列表
- [ ] 统计卡片正确显示（总规则数、已启用、已禁用、严重级别）

#### 1.2 搜索功能
- [ ] 输入关键词搜索规则名称
- [ ] 输入关键词搜索规则描述
- [ ] 搜索结果正确过滤
- [ ] 清空搜索框恢复全部数据

#### 1.3 筛选功能
- [ ] 按监控指标筛选（CPU、内存、磁盘、负载）
- [ ] 按严重级别筛选（信息、警告、严重）
- [ ] 按状态筛选（已启用、已禁用）
- [ ] 多个筛选条件组合使用
- [ ] 筛选结果正确显示

#### 1.4 分页功能
- [ ] 切换页码正常工作
- [ ] 修改每页显示数量正常工作
- [ ] 快速跳转到指定页码
- [ ] 分页信息正确显示

#### 1.5 规则操作
- [ ] 点击规则名称跳转到编辑页面
- [ ] 启用/禁用规则按钮正常工作
- [ ] 编辑按钮跳转到编辑页面
- [ ] 删除按钮弹出确认对话框
- [ ] 确认删除后规则被删除
- [ ] 取消删除后规则保留

#### 1.6 权限控制
- [ ] 无权限用户不显示创建按钮
- [ ] 无权限用户不显示编辑按钮
- [ ] 无权限用户不显示删除按钮

### 二、创建规则页面测试

#### 2.1 页面访问
- [ ] 点击"创建规则"按钮跳转到创建页面
- [ ] 页面正常加载
- [ ] 表单字段显示正确

#### 2.2 基本信息
- [ ] 规则名称必填验证
- [ ] 规则名称长度限制
- [ ] 描述字段可选

#### 2.3 监控条件
- [ ] 监控指标下拉选择正常
- [ ] 条件操作符下拉选择正常
- [ ] 阈值输入验证（0-100）
- [ ] 持续时间输入验证（非负数）
- [ ] 严重级别下拉选择正常
- [ ] 静默期输入验证（非负数）

#### 2.4 应用范围
- [ ] "应用到所有主机"复选框正常工作
- [ ] 取消"应用到所有主机"后显示主机列表
- [ ] 主机列表正确加载
- [ ] 主机选择功能正常
- [ ] 至少选择一台主机的验证

#### 2.5 告警渠道
- [ ] 告警渠道列表正确加载
- [ ] 渠道选择功能正常
- [ ] 至少选择一个渠道的验证
- [ ] 显示渠道类型（邮件、钉钉等）

#### 2.6 规则状态
- [ ] "启用此规则"复选框正常工作
- [ ] 默认状态为启用

#### 2.7 表单提交
- [ ] 必填字段验证正常
- [ ] 提交成功后显示成功提示
- [ ] 提交成功后跳转到列表页面
- [ ] 提交失败显示错误提示
- [ ] 取消按钮返回列表页面

### 三、编辑规则页面测试

#### 3.1 页面访问
- [ ] 点击编辑按钮跳转到编辑页面
- [ ] 页面正常加载
- [ ] 表单字段显示现有数据

#### 3.2 数据回显
- [ ] 规则名称正确回显
- [ ] 描述正确回显
- [ ] 监控指标正确回显
- [ ] 条件操作符正确回显
- [ ] 阈值正确回显
- [ ] 持续时间正确回显
- [ ] 严重级别正确回显
- [ ] 静默期正确回显
- [ ] 应用范围正确回显
- [ ] 主机选择正确回显
- [ ] 告警渠道选择正确回显
- [ ] 规则状态正确回显

#### 3.3 表单修改
- [ ] 修改各字段正常工作
- [ ] 表单验证正常
- [ ] 更新成功后显示成功提示
- [ ] 更新成功后跳转到列表页面
- [ ] 更新失败显示错误提示

### 四、UI/UX测试

#### 4.1 响应式设计
- [ ] 桌面端显示正常
- [ ] 平板端显示正常
- [ ] 移动端显示正常

#### 4.2 深色模式
- [ ] 切换到深色模式显示正常
- [ ] 所有组件颜色适配正确
- [ ] 文字对比度足够

#### 4.3 交互反馈
- [ ] 按钮悬停效果正常
- [ ] 加载状态显示正常
- [ ] Toast提示显示正常
- [ ] 确认对话框显示正常

#### 4.4 性能
- [ ] 页面加载速度快
- [ ] 搜索响应及时（防抖）
- [ ] 表格滚动流畅
- [ ] 无明显卡顿

### 五、错误处理测试

#### 5.1 网络错误
- [ ] 后端服务停止时显示错误提示
- [ ] 网络超时显示错误提示
- [ ] 错误提示信息清晰

#### 5.2 数据验证
- [ ] 必填字段为空时显示错误
- [ ] 数据格式错误时显示错误
- [ ] 数据范围错误时显示错误

#### 5.3 权限错误
- [ ] 无权限操作时显示错误提示
- [ ] 自动跳转到登录页面（如需要）

### 六、集成测试

#### 6.1 与告警渠道集成
- [ ] 创建规则时可以选择已配置的渠道
- [ ] 渠道禁用后不能选择
- [ ] 渠道删除后规则显示异常

#### 6.2 与主机管理集成
- [ ] 创建规则时可以选择已添加的主机
- [ ] 主机删除后规则显示异常

#### 6.3 与告警记录集成
- [ ] 规则触发后生成告警记录
- [ ] 规则列表显示近期告警数量
- [ ] 有活跃告警的规则无法删除

## 测试数据准备

### 1. 创建测试告警渠道
```
名称：测试邮件渠道
类型：email
配置：SMTP服务器配置
```

### 2. 创建测试主机
```
名称：测试服务器01
地址：192.168.1.100
端口：22
```

### 3. 创建测试规则
```
名称：测试CPU告警
监控指标：CPU使用率
条件：> 80%
严重级别：警告
应用范围：所有主机
告警渠道：测试邮件渠道
```

## 常见问题排查

### 1. 页面无法加载
- 检查后端服务是否运行
- 检查API地址配置是否正确
- 检查浏览器控制台错误信息

### 2. 数据不显示
- 检查API返回数据格式
- 检查数据权限
- 检查租户隔离

### 3. 操作失败
- 检查用户权限
- 检查后端日志
- 检查网络请求

### 4. 样式异常
- 清除浏览器缓存
- 检查CSS文件加载
- 检查Tailwind配置

## 测试报告模板

```
测试日期：____年__月__日
测试人员：________
测试环境：________

功能测试结果：
- 规则列表：✓ 通过 / ✗ 失败
- 创建规则：✓ 通过 / ✗ 失败
- 编辑规则：✓ 通过 / ✗ 失败
- 删除规则：✓ 通过 / ✗ 失败
- 启用/禁用：✓ 通过 / ✗ 失败

发现的问题：
1. ________
2. ________

建议改进：
1. ________
2. ________
```

## 自动化测试

### E2E测试示例（Playwright）

```typescript
// admin-mit-ui/e2e/alert-rules.spec.ts
import { test, expect } from '@playwright/test'

test.describe('告警规则管理', () => {
  test.beforeEach(async ({ page }) => {
    // 登录
    await page.goto('/login')
    await page.fill('input[name="username"]', 'admin')
    await page.fill('input[name="password"]', 'admin123')
    await page.click('button[type="submit"]')
    await page.waitForURL('/dashboard')
  })

  test('应该能够访问规则列表', async ({ page }) => {
    await page.goto('/monitor/rules')
    await expect(page).toHaveURL('/monitor/rules/list')
    await expect(page.locator('h1')).toContainText('告警规则')
  })

  test('应该能够创建新规则', async ({ page }) => {
    await page.goto('/monitor/rules/create')
    await page.fill('input[name="name"]', '测试规则')
    await page.selectOption('select[name="metric_type"]', 'cpu')
    await page.fill('input[name="threshold_value"]', '80')
    // ... 填写其他字段
    await page.click('button[type="submit"]')
    await expect(page).toHaveURL('/monitor/rules/list')
  })

  test('应该能够编辑规则', async ({ page }) => {
    await page.goto('/monitor/rules/list')
    await page.click('button[title="编辑规则"]')
    await page.fill('input[name="name"]', '修改后的规则名称')
    await page.click('button[type="submit"]')
    await expect(page.locator('.toast')).toContainText('更新成功')
  })

  test('应该能够删除规则', async ({ page }) => {
    await page.goto('/monitor/rules/list')
    await page.click('button[title="删除规则"]')
    await page.click('button:has-text("确认删除")')
    await expect(page.locator('.toast')).toContainText('删除成功')
  })
})
```

运行测试：
```bash
npm run test:e2e
```
