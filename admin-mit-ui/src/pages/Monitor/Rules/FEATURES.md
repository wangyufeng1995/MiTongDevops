# 告警规则功能特性详解

## 功能架构

```
告警规则管理
├── 规则列表 (RuleList)
│   ├── 数据展示
│   │   ├── 统计卡片
│   │   ├── 规则表格
│   │   └── 分页控制
│   ├── 搜索筛选
│   │   ├── 关键词搜索
│   │   ├── 指标筛选
│   │   ├── 级别筛选
│   │   └── 状态筛选
│   └── 规则操作
│       ├── 创建规则
│       ├── 编辑规则
│       ├── 删除规则
│       ├── 启用规则
│       └── 禁用规则
└── 规则表单 (RuleForm)
    ├── 基本信息
    │   ├── 规则名称
    │   └── 规则描述
    ├── 监控条件
    │   ├── 监控指标
    │   ├── 条件操作符
    │   ├── 阈值设置
    │   ├── 持续时间
    │   ├── 严重级别
    │   └── 静默期
    ├── 应用范围
    │   ├── 所有主机
    │   └── 指定主机
    ├── 告警渠道
    │   └── 多渠道选择
    └── 规则状态
        └── 启用/禁用
```

## 核心功能详解

### 1. 规则列表页面

#### 1.1 统计卡片
显示关键指标的实时统计：
- **总规则数**：系统中配置的所有告警规则数量
- **已启用**：当前正在运行的规则数量，用绿色高亮显示
- **已禁用**：暂停的规则数量，用灰色显示
- **严重级别**：严重告警规则数量，超过0时用红色警告显示

#### 1.2 搜索和筛选
提供多维度的数据筛选能力：

**关键词搜索**
- 支持搜索规则名称
- 支持搜索规则描述
- 实时搜索（300ms防抖）
- 搜索结果高亮显示

**监控指标筛选**
- CPU使用率
- 内存使用率
- 磁盘使用率
- 系统负载

**严重级别筛选**
- 信息（Info）
- 警告（Warning）
- 严重（Critical）

**状态筛选**
- 已启用
- 已禁用

#### 1.3 规则表格
以表格形式展示规则详细信息：

| 列名 | 说明 | 特性 |
|------|------|------|
| 规则名称 | 规则的唯一标识 | 可点击跳转到编辑页面 |
| 监控指标 | 监控的系统指标 | 显示指标类型和阈值条件 |
| 严重级别 | 告警的严重程度 | 彩色标签显示 |
| 应用范围 | 规则应用的主机范围 | 显示"所有主机"或主机数量 |
| 告警渠道 | 配置的通知渠道 | 显示前2个渠道，超过显示"+N" |
| 近期告警 | 最近7天的告警次数 | 有告警时红色高亮 |
| 状态 | 规则的启用状态 | 绿色/灰色标签 |
| 操作 | 可执行的操作按钮 | 启用/禁用、编辑、删除 |

#### 1.4 快速操作
- **启用/禁用**：点击电源图标即可快速切换规则状态
- **编辑**：点击编辑图标跳转到编辑页面
- **删除**：点击删除图标，弹出确认对话框

### 2. 规则表单页面

#### 2.1 基本信息配置

**规则名称**（必填）
- 用于标识规则的唯一名称
- 建议使用描述性名称，如"生产服务器CPU告警"
- 长度限制：1-100字符

**规则描述**（可选）
- 详细说明规则的用途和触发条件
- 帮助团队成员理解规则的意图
- 长度限制：0-500字符

#### 2.2 监控条件配置

**监控指标**
- **CPU使用率**：监控CPU的使用百分比
- **内存使用率**：监控内存的使用百分比
- **磁盘使用率**：监控磁盘空间的使用百分比
- **系统负载**：监控系统的平均负载

**条件操作符**
- `>` 大于：当指标值大于阈值时触发
- `>=` 大于等于：当指标值大于或等于阈值时触发
- `<` 小于：当指标值小于阈值时触发
- `<=` 小于等于：当指标值小于或等于阈值时触发
- `==` 等于：当指标值等于阈值时触发

**阈值设置**
- 范围：0-100%
- 精度：支持小数
- 示例：80表示80%

**持续时间**
- 单位：秒
- 说明：条件持续满足多久后才触发告警
- 目的：避免瞬时波动导致的误报
- 建议值：300秒（5分钟）

**严重级别**
- **信息（Info）**：一般性通知，不需要立即处理
- **警告（Warning）**：需要关注，但不紧急
- **严重（Critical）**：需要立即处理的严重问题

**静默期**
- 单位：秒
- 说明：同一告警的最小间隔时间
- 目的：避免短时间内重复发送相同告警
- 建议值：3600秒（1小时）

#### 2.3 应用范围配置

**应用到所有主机**
- 勾选后，规则将应用到租户下的所有主机
- 适用于通用的监控规则
- 新增主机会自动应用此规则

**指定主机**
- 取消"应用到所有主机"后显示主机列表
- 支持多选
- 显示主机名称和IP地址
- 至少选择一台主机

#### 2.4 告警渠道配置

**渠道选择**
- 支持选择多个告警渠道
- 显示渠道名称和类型
- 只能选择已启用的渠道
- 至少选择一个渠道

**渠道类型**
- **邮件（Email）**：通过SMTP发送邮件通知
- **钉钉（DingTalk）**：通过钉钉机器人发送消息

#### 2.5 规则状态

**启用此规则**
- 勾选后规则立即生效
- 取消勾选后规则暂停，不会触发告警
- 默认状态：启用

### 3. 数据流程

#### 3.1 规则创建流程
```
用户填写表单
    ↓
前端表单验证
    ↓
提交到后端API
    ↓
后端数据验证
    ↓
检查渠道和主机是否存在
    ↓
创建规则记录
    ↓
返回成功响应
    ↓
前端显示成功提示
    ↓
跳转到规则列表
```

#### 3.2 规则触发流程
```
监控系统采集指标数据
    ↓
与规则条件比较
    ↓
条件满足且持续时间达到
    ↓
检查静默期
    ↓
创建告警记录
    ↓
通过配置的渠道发送通知
    ↓
记录通知状态
```

#### 3.3 规则更新流程
```
加载现有规则数据
    ↓
用户修改表单
    ↓
前端表单验证
    ↓
提交到后端API
    ↓
后端数据验证
    ↓
更新规则记录
    ↓
返回成功响应
    ↓
前端显示成功提示
    ↓
跳转到规则列表
```

## 技术实现

### 1. 状态管理

使用React Hooks管理组件状态：
```typescript
interface RuleListState {
  rules: AlertRule[]              // 规则列表
  loading: boolean                // 加载状态
  error: string | null            // 错误信息
  pagination: PaginationInfo      // 分页信息
  search: string                  // 搜索关键词
  metricFilter: string            // 指标筛选
  severityFilter: string          // 级别筛选
  enabledFilter: string           // 状态筛选
  toast: ToastInfo                // 提示信息
}
```

### 2. API交互

使用统一的API客户端：
```typescript
// 获取规则列表
const response = await api.get('/api/monitor/rules', {
  params: { page, per_page, search, metric_type, severity, enabled }
})

// 创建规则
const response = await api.post('/api/monitor/rules', formData)

// 更新规则
const response = await api.put(`/api/monitor/rules/${id}`, formData)

// 删除规则
const response = await api.post(`/api/monitor/rules/${id}/delete`)

// 启用规则
const response = await api.post(`/api/monitor/rules/${id}/enable`)

// 禁用规则
const response = await api.post(`/api/monitor/rules/${id}/disable`)
```

### 3. 表单验证

实时验证用户输入：
```typescript
const validateForm = (): boolean => {
  const newErrors: Partial<Record<keyof FormData, string>> = {}

  if (!formData.name.trim()) 
    newErrors.name = '规则名称不能为空'
  
  if (formData.threshold_value < 0 || formData.threshold_value > 100)
    newErrors.threshold_value = '阈值必须在0-100之间'
  
  if (formData.channel_ids.length === 0)
    newErrors.channel_ids = '至少选择一个告警渠道'
  
  // ... 更多验证规则

  setErrors(newErrors)
  return Object.keys(newErrors).length === 0
}
```

### 4. 权限控制

基于用户权限显示操作按钮：
```typescript
{hasPermission('monitor:create') && (
  <button onClick={() => navigate('/monitor/rules/create')}>
    创建规则
  </button>
)}

{hasPermission('monitor:update') && (
  <button onClick={() => navigate(`/monitor/rules/edit/${rule.id}`)}>
    编辑
  </button>
)}

{hasPermission('monitor:delete') && (
  <button onClick={() => handleDelete(rule)}>
    删除
  </button>
)}
```

### 5. 响应式设计

使用Tailwind CSS实现响应式布局：
```typescript
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
  {/* 统计卡片 */}
</div>

<div className="flex flex-wrap items-end gap-4">
  {/* 搜索和筛选 */}
</div>
```

### 6. 深色模式支持

根据主题动态调整样式：
```typescript
const { isDark } = useTheme()

<div className={`
  ${isDark 
    ? 'bg-slate-700/50 border-slate-600 text-white' 
    : 'bg-white border-gray-200 text-gray-900'
  }
`}>
  {/* 内容 */}
</div>
```

## 用户体验优化

### 1. 加载状态
- 页面加载时显示骨架屏
- 操作执行时显示加载动画
- 防止重复提交

### 2. 错误处理
- 网络错误友好提示
- 表单验证实时反馈
- 操作失败详细说明

### 3. 交互反馈
- Toast提示（成功/失败/警告/信息）
- 按钮悬停效果
- 确认对话框

### 4. 性能优化
- 搜索防抖（300ms）
- 分页加载
- 虚拟滚动（大数据量）
- 组件懒加载

### 5. 可访问性
- 语义化HTML
- 键盘导航支持
- ARIA标签
- 颜色对比度

## 最佳实践

### 1. 规则命名
- 使用描述性名称
- 包含监控对象和指标
- 示例：`生产服务器-CPU使用率告警`

### 2. 阈值设置
- CPU：80-90%
- 内存：85-95%
- 磁盘：90-95%
- 负载：根据CPU核心数设置

### 3. 持续时间
- 短期波动：60-300秒
- 持续问题：300-600秒
- 避免过短导致误报

### 4. 静默期
- 一般告警：3600秒（1小时）
- 严重告警：1800秒（30分钟）
- 避免告警轰炸

### 5. 渠道选择
- 信息级别：邮件
- 警告级别：邮件 + 钉钉
- 严重级别：邮件 + 钉钉 + 短信

## 常见场景

### 场景1：CPU使用率告警
```
规则名称：生产服务器CPU告警
监控指标：CPU使用率
条件：> 80%
持续时间：300秒
严重级别：警告
应用范围：生产服务器组
告警渠道：邮件 + 钉钉
静默期：3600秒
```

### 场景2：内存使用率告警
```
规则名称：数据库服务器内存告警
监控指标：内存使用率
条件：> 90%
持续时间：180秒
严重级别：严重
应用范围：数据库服务器
告警渠道：邮件 + 钉钉 + 短信
静默期：1800秒
```

### 场景3：磁盘空间告警
```
规则名称：日志服务器磁盘告警
监控指标：磁盘使用率
条件：> 85%
持续时间：600秒
严重级别：警告
应用范围：日志服务器
告警渠道：邮件
静默期：7200秒
```

### 场景4：系统负载告警
```
规则名称：Web服务器负载告警
监控指标：系统负载
条件：> 4.0
持续时间：300秒
严重级别：警告
应用范围：Web服务器组
告警渠道：邮件 + 钉钉
静默期：3600秒
```

## 扩展功能建议

### 1. 规则模板
- 预定义常用规则模板
- 一键创建标准规则
- 支持自定义模板

### 2. 规则测试
- 模拟告警触发
- 验证渠道配置
- 预览告警内容

### 3. 规则分组
- 按业务分组
- 按环境分组
- 批量管理

### 4. 告警统计
- 规则触发频率
- 告警趋势图表
- 渠道发送统计

### 5. 规则依赖
- 规则之间的依赖关系
- 级联告警
- 告警抑制

### 6. 动态阈值
- 基于历史数据的动态阈值
- 机器学习预测
- 异常检测

### 7. 告警升级
- 多级告警
- 自动升级
- 值班轮换

### 8. 规则审计
- 规则变更历史
- 操作日志
- 合规检查
